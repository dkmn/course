<?php

require_once(drupal_get_path('module', 'course') . '/tests/CourseTestCase.test');

/**
 * Tests for conditional event-based access to course objects.
 */
class CourseAccessTestCase extends CourseTestCase {

  public static function getInfo() {
    // Note that getInfo() strings are not translated with t().
    return array(
      'name' => 'Course access',
      'description' => 'Ensure that Course access control functions properly.',
      'group' => 'Course',
    );
  }

  /**
   * If a course has duration, make sure it gets set.
   */
  function testCourseDuration() {
    global $user;
    $courseNode = $this->createCourseNode();
    $courseNode->course['duration'] = 30;
    node_save($courseNode);
    $enrol = course_enrolment_load($courseNode, $user);
    $this->assertFalse($enrol->enrol_end, 'Duration not set.');
    course_take_course($courseNode);
    $enrol = course_enrolment_load($courseNode, $user);
    $this->assertTrue($enrol->enrol_end > time() + 900, 'Duration end got set with course start.');
    $result = course_take_course_access($courseNode, $user, TRUE);
    $this->assertTrue($result['success'], 'User can access course with non-expired enrollment.');

    // Check expire.
    $enrol = course_enrolment_load($courseNode, $user);
    $enrol->enrol_end = 1;
    course_enrolment_save($enrol);
    $result = course_take_course_access($courseNode, $user, TRUE);
    $this->assertFalse($result['success'], 'User cannot access course with expired enrollment.');
  }

}
